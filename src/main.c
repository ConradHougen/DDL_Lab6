/*
===============================================================================
 Name        : main.c
 Author      : $(author)
 Version     :
 Copyright   : $(copyright)
 Description : main definition
===============================================================================
*/

#ifdef __USE_CMSIS
#include "LPC11xx.h"
#endif

#include <cr_section_macros.h>

#include <stdio.h>

/*****************************************************************************
 *   Bridge.c:  Communication Code for ARM and DE0
 *   Author: Qi
 *	 Timer interrupt to send out data at fixed interval
 *	 External interrupt to receive and control LED
 *
 *	 Interface Description-
 *   1. Pin 3-2: clk
 *   2. Pin 3-1: serial data out
 *   3. Pin 2-1: data in
 *   4. Pin 2-2: handshake
 *   5. Pin 2-0: reset
 *   6. Pin 0-7: LED
******************************************************************************/

#include "driver_config.h"
#include "target_config.h"

#include "gpio.h"
#include "timer32.h"


/* Main Program */

/*----Provided Noisy Morse Data for You----*/
const int16_t morse[1600] = {109,145,145,109,50,-9,5,-45,-9,50,159,145,145,159,100,41,-45,-45,-9,50,109,145,195,109,50,-9,5,-45,-9,100,159,195,145,109,50,-9,-45,-45,41,50,109,145,195,109,50,41,5,5,-9,50,109,145,145,109,100,-9,-45,-45,41,50,109,195,195,159,50,-9,-45,-45,-9,50,159,145,145,109,100,-9,-45,5,41,100,109,145,145,109,50,-9,5,-45,-9,50,159,145,145,159,100,41,-45,-45,-9,50,109,145,195,109,50,-9,5,-45,-9,100,159,195,145,109,50,-9,-45,-45,41,50,109,145,195,109,50,41,5,5,-9,50,109,145,145,109,100,-9,-45,-45,41,50,109,195,195,159,50,-9,-45,-45,-9,50,159,145,145,109,100,-9,-45,5,41,100,109,145,145,109,50,-9,5,-45,-9,50,159,145,145,159,100,41,-45,-45,-9,50,109,145,195,109,50,-9,5,-45,-9,100,159,195,145,109,50,-9,-45,-45,41,50,109,145,195,109,50,41,5,5,-9,50,109,145,145,109,100,-9,-45,-45,41,50,109,195,195,159,50,-9,-45,-45,-9,50,159,145,145,109,100,-9,-45,5,41,100,109,145,145,109,50,-9,5,-45,-9,50,159,145,145,159,100,41,-45,-45,-9,50,109,145,195,109,50,-9,5,-45,-9,100,159,195,145,109,50,-9,-45,-45,41,50,109,145,195,109,50,41,5,5,-9,50,109,145,145,109,100,-9,-45,-45,41,50,109,195,195,159,50,-9,-45,-45,-9,50,159,145,145,109,100,-9,-45,5,41,100,109,145,145,109,50,-9,5,-45,-9,50,159,145,145,159,100,41,-45,-45,-9,50,109,145,195,109,50,-9,5,-45,-9,100,159,195,145,109,50,-9,-45,-45,41,50,109,145,195,109,50,41,5,5,-9,50,109,145,145,109,100,-9,-45,-45,41,50,109,195,195,159,50,-9,-45,-45,-9,50,159,145,145,109,100,-9,-45,5,41,100,109,145,145,109,50,-9,5,-45,-9,50,159,145,145,159,100,41,-45,-45,-9,50,109,145,195,109,50,-9,5,-45,-9,100,159,195,145,109,50,-9,-45,-45,41,50,109,145,195,109,50,41,5,5,-9,50,109,145,145,109,100,-9,-45,-45,41,50,109,195,195,159,50,-9,-45,-45,-9,50,159,145,145,109,100,-9,-45,5,41,100,109,145,145,109,50,-9,5,-45,-9,50,159,145,145,159,100,41,-45,-45,-9,50,109,145,195,109,50,-9,5,-45,-9,100,159,195,145,109,50,-9,-45,-45,41,50,109,145,195,109,50,41,5,5,-9,50,109,145,145,109,100,-9,-45,-45,41,50,109,195,195,159,50,-9,-45,-45,-9,50,159,145,145,109,100,-9,-45,5,41,100,109,145,145,109,50,-9,5,-45,-9,50,159,145,145,159,100,41,-45,-45,-9,50,109,145,195,109,50,-9,5,-45,-9,100,159,195,145,109,50,-9,-45,-45,41,50,109,145,195,109,50,41,5,5,-9,50,109,145,145,109,100,-9,-45,-45,41,50,109,195,195,159,50,-9,-45,-45,-9,50,159,145,145,109,100,-9,-45,5,41,100,109,145,145,109,50,-9,5,-45,-9,50,159,145,145,159,100,41,-45,-45,-9,50,109,145,195,109,50,-9,5,-45,-9,100,159,195,145,109,50,-9,-45,-45,41,50,109,145,195,109,50,41,5,5,-9,50,109,145,145,109,100,-9,-45,-45,41,50,109,195,195,159,50,-9,-45,-45,-9,50,159,145,145,109,100,-9,-45,5,41,100,109,145,145,109,50,-9,5,-45,-9,50,159,145,145,159,100,41,-45,-45,-9,50,109,145,195,109,50,-9,5,-45,-9,100,159,195,145,109,50,-9,-45,-45,41,50,109,145,195,109,50,41,5,5,-9,50,109,145,145,109,100,-9,-45,-45,41,50,109,195,195,159,50,-9,-45,-45,-9,50,159,145,145,109,100,-9,-45,5,41,100,109,145,145,109,50,-9,5,-45,-9,50,159,145,145,159,100,41,-45,-45,-9,50,109,145,195,109,50,-9,5,-45,-9,100,159,195,145,109,50,-9,-45,-45,41,50,109,145,195,109,50,41,5,5,-9,50,109,145,145,109,100,-9,-45,-45,41,50,109,195,195,159,50,-9,-45,-45,-9,50,159,145,145,109,100,-9,-45,5,41,100,109,145,145,109,50,-9,5,-45,-9,50,159,145,145,159,100,41,-45,-45,-9,50,109,145,195,109,50,-9,5,-45,-9,100,159,195,145,109,50,-9,-45,-45,41,50,109,145,195,109,50,41,5,5,-9,50,109,145,145,109,100,-9,-45,-45,41,50,109,195,195,159,50,-9,-45,-45,-9,50,159,145,145,109,100,-9,-45,5,41,100,109,145,145,109,50,-9,5,-45,-9,50,159,145,145,159,100,41,-45,-45,-9,50,109,145,195,109,50,-9,5,-45,-9,100,159,195,145,109,50,-9,-45,-45,41,50,109,145,195,109,50,41,5,5,-9,50,109,145,145,109,100,-9,-45,-45,41,50,109,195,195,159,50,-9,-45,-45,-9,50,159,145,145,109,100,-9,-45,5,41,100,109,145,145,109,50,-9,5,-45,-9,50,159,145,145,159,100,41,-45,-45,-9,50,109,145,195,109,50,-9,5,-45,-9,100,159,195,145,109,50,-9,-45,-45,41,50,109,145,195,109,50,41,5,5,-9,50,109,145,145,109,100,-9,-45,-45,41,50,109,195,195,159,50,-9,-45,-45,-9,50,159,145,145,109,100,-9,-45,5,41,100,109,145,145,109,50,-9,5,-45,-9,50,159,145,145,159,100,41,-45,-45,-9,50,109,145,195,109,50,-9,5,-45,-9,100,159,195,145,109,50,-9,-45,-45,41,50,109,145,195,109,50,41,5,5,-9,50,109,145,145,109,100,-9,-45,-45,41,50,109,195,195,159,50,-9,-45,-45,-9,50,159,145,145,109,100,-9,-45,5,41,100,109,145,145,109,50,-9,5,-45,-9,50,159,145,145,159,100,41,-45,-45,-9,50,109,145,195,109,50,-9,5,-45,-9,100,159,195,145,109,50,-9,-45,-45,41,50,109,145,195,109,50,41,5,5,-9,50,109,145,145,109,100,-9,-45,-45,41,50,109,195,195,159,50,-9,-45,-45,-9,50,159,145,145,109,100,-9,-45,5,41,100,109,145,145,109,50,-9,5,-45,-9,50,159,145,145,159,100,41,-45,-45,-9,50,109,145,195,109,50,-9,5,-45,-9,100,159,195,145,109,50,-9,-45,-45,41,50,109,145,195,109,50,41,5,5,-9,50,109,145,145,109,100,-9,-45,-45,41,50,109,195,195,159,50,-9,-45,-45,-9,50,159,145,145,109,100,-9,-45,5,41,100,109,145,145,109,50,-9,5,-45,-9,50,159,145,145,159,100,41,-45,-45,-9,50,109,145,195,109,50,-9,5,-45,-9,100,159,195,145,109,50,-9,-45,-45,41,50,109,145,195,109,50,41,5,5,-9,50,109,145,145,109,100,-9,-45,-45,41,50,109,195,195,159,50,-9,-45,-45,-9,50,159,145,145,109,100,-9,-45,5,41,100,109,145,145,109,50,-9,5,-45,-9,50,159,145,145,159,100,41,-45,-45,-9,50,109,145,195,109,50,-9,5,-45,-9,100,159,195,145,109,50,-9,-45,-45,41,50,109,145,195,109,50,41,5,5,-9,50,109,145,145,109,100,-9,-45,-45,41,50,109,195,195,159,50,-9,-45,-45,-9,50,159,145,145,109,100,-9,-45,5,41,100,109,145,145,109,50,-9,5,-45,-9,50,159,145,145,159,100,41,-45,-45,-9,50,109,145,195,109,50,-9,5,-45,-9,100,159,195,145,109,50,-9,-45,-45,41,50,109,145,195,109,50,41,5,5,-9,50,109,145,145,109,100,-9,-45,-45,41,50,109,195,195,159,50,-9,-45,-45,-9,50,159,145,145,109,100,-9,-45,5,41,100
};//ABC
const uint32_t length = 1600;//morse code data length



// 1ms timer interval
#define TIMER_INTERVAL (SystemCoreClock/1000 - 1)

#define GPIO2_IS ((int *)0x50028004UL)
#define GPIO2_IBE ((int *)0x50028008UL)
#define GPIO2_IEV ((int *)0x5002800CUL)
#define GPIO2_IE ((int *)0x50028010UL)
#define GPIO2_IC ((int *)0x5002801CUL)

/*	 Interface Description-
*   1. Pin 3-2: clk
*   2. Pin 3-1: serial data out
*   3. Pin 2-1: data in
*   4. Pin 2-2: handshake
*   5. Pin 2-0: reset
*   6. Pin 0-7: LED */
#define CLK_PORT 3
#define CLK 2
#define DOUT_PORT 3
#define DOUT 1
#define DIN_PORT 2
#define DIN 1
#define HNDSHK_PORT 2
#define HNDSHK 2
#define RESET_PORT 2
#define RESET 0
#define LED_PORT 0
#define LED 7


int returned_num = 0;

int main (void) {

/*To-do
* 1. System Initialization
*/
	uint32_t last_timer_count = 0;
	int ten_bit_num = 0x2AA;
	int num_bits = 10;
	int bit = 0;
	int i;

/*2. GPIO Initialization
 * GPIO for LED control
 * GPIOs for communication protocol: clock, handshake, reset, data input, data output
 */
	/* Initialize GPIO (sets up clock) */
	/* set edge triggering */
	*GPIO2_IS &= ~(0x1<<1);
	/* single edge */
	*GPIO2_IBE |= (0x1<<1);
	/* active high */
	//*GPIO2_IEV &= ~(0x1<<1);
	/* enable interrupt on pin 1 */
	*GPIO2_IE |= (0x1<<1);
	/* Set priority of gpio2 interrupt to 0 */
	NVIC_SetPriority(EINT2_IRQn, 0);

	GPIOInit();
	GPIOSetDir( LED_PORT, LED, 1 );
	GPIOSetDir( CLK_PORT, CLK, 1 );
	GPIOSetDir( HNDSHK_PORT, HNDSHK, 1 );
	GPIOSetDir( RESET_PORT, RESET, 1 );
	GPIOSetDir( DOUT_PORT, DOUT, 1 );
	GPIOSetDir( DIN_PORT, DIN, 0 );


/*3. Timer Initialization
 * One Timer for generating clock, handshake, data output schedule
 */
	/* init and enable timer */
	init_timer32( 0, TIME_INTERVAL );
	enable_timer32( 0 );


/*4. Reset DE0 FIR filter
* Generate a short pulse to reset DE0
*/
	GPIOSetValue( RESET_PORT, RESET, 0 );
	last_timer_count = timer32_0_counter; // store the time
	while(timer32_0_counter < last_timer_count + 10); // delay 10ms
	GPIOSetValue( RESET_PORT, RESET, 1 );

	GPIOSetValue( LED_PORT, LED, 0 );

	while (1) {
		// periodically, send data to the DE0
		returned_num = 0;

		// set the handshake high
		GPIOSetValue( HNDSHK_PORT, HNDSHK, 1);

		// send the bits
		for(i = 0; i < num_bits; ++i)
		{
			bit = ((ten_bit_num >> i) & 0x1); // get the next bit to send
			GPIOSetValue( DOUT_PORT, DOUT, bit); // set the data out value
			last_timer_count = timer32_0_counter; // store the time
			GPIOSetValue( CLK_PORT, CLK, 1); // signal DE0 to get data
			while(timer32_0_counter < last_timer_count + 100); // delay 100ms
			GPIOSetValue( CLK_PORT, CLK, 0); // pull clock low
			while(timer32_0_counter < last_timer_count + 200); // delay ~100ms
		}

		// done sending data, so lower the handshake
		GPIOSetValue( HNDSHK_PORT, HNDSHK, 0);

		// get the data back from the DE0 by clocking with handshake low
		for(i = 0; i < num_bits; ++i)
		{
			last_timer_count = timer32_0_counter; // store the time
			GPIOSetValue( CLK_PORT, CLK, 1); // signal DE0 to get data
			while(timer32_0_counter < last_timer_count + 100); // delay 100ms
			GPIOSetValue( CLK_PORT, CLK, 0); // pull clock low
			while(timer32_0_counter < last_timer_count + 200); // delay ~100ms
		}


		//for(;;);
		// delay
		last_timer_count = timer32_0_counter;
		while(timer32_0_counter < last_timer_count + 10000); // delay 10 seconds
	};                                /* Loop forever */

	return 1;
}//end of main function


/*-----Interrupt handler for external interrupt 2-----
 * config to both rising and falling edge to sense the data input from DE0
 * turn LED on/off
 */
void PIOINT2_IRQHandler(void)
{
	int data_bit_in = (LPC_GPIO2->DATA >> 1) & 0x1;
	if(data_bit_in == 0x1)
	{
		GPIOSetValue( LED_PORT, LED, 1 );
	}
	else if(data_bit_in == 0x0)
	{
		GPIOSetValue( LED_PORT, LED, 0 );
	}
	returned_num = (returned_num << 1) + data_bit_in;

	// clear the interrupt on pin 1
	*GPIO2_IC |= (0x1<<1);

} //end of external interrupt



/*-----interrupt handler for timer32_0-----
 * generate handshake
 * generate bit output clock
 * send out a sample bit by bit (every interrupt, send out one data sample)
 */
/*
void TIMER32_0_IRQHandler(void)
{





} //end of timer interrupt
*/
